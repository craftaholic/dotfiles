#!/bin/bash

# Script to start/stop EC2 instance with tag workspace=true
# Usage: workspace start|stop

set -e

AWS_PROFILE="personal"
TAG_KEY="Workspace"
TAG_VALUE="true"
SSH_KEY="$HOME/Documents/workspace.pem"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# Function to get instance ID by tag
get_instance_id() {
    local instance_id=$(aws ec2 describe-instances \
        --profile "$AWS_PROFILE" \
        --filters "Name=tag:${TAG_KEY},Values=${TAG_VALUE}" "Name=instance-state-name,Values=running,stopped" \
        --query "Reservations[0].Instances[0].InstanceId" \
        --output text 2>/dev/null)
    
    if [ "$instance_id" == "None" ] || [ -z "$instance_id" ]; then
        return 1
    fi
    
    echo "$instance_id"
    return 0
}

# Function to get instance state
get_instance_state() {
    local instance_id=$1
    aws ec2 describe-instances \
        --profile "$AWS_PROFILE" \
        --instance-ids "$instance_id" \
        --query "Reservations[0].Instances[0].State.Name" \
        --output text 2>/dev/null
}

# Function to start instance
start_instance() {
    local instance_id=$1
    local state=$(get_instance_state "$instance_id")
    
    if [ "$state" == "running" ]; then
        print_warning "Instance $instance_id is already running"
        return 0
    fi
    
    print_info "Starting instance $instance_id..."
    aws ec2 start-instances \
        --profile "$AWS_PROFILE" \
        --instance-ids "$instance_id" \
        --output json > /dev/null
    
    print_info "Waiting for instance to start..."
    aws ec2 wait instance-running \
        --profile "$AWS_PROFILE" \
        --instance-ids "$instance_id"
    
    print_info "Instance $instance_id is now running"
    
    # Get and display public IP if available
    local public_ip=$(aws ec2 describe-instances \
        --profile "$AWS_PROFILE" \
        --instance-ids "$instance_id" \
        --query "Reservations[0].Instances[0].PublicIpAddress" \
        --output text 2>/dev/null)
    
    if [ "$public_ip" != "None" ] && [ -n "$public_ip" ]; then
        print_info "Public IP: $public_ip"
    fi
}

# Function to stop instance
stop_instance() {
    local instance_id=$1
    local state=$(get_instance_state "$instance_id")
    
    if [ "$state" == "stopped" ]; then
        print_warning "Instance $instance_id is already stopped"
        return 0
    fi
    
    print_info "Stopping instance $instance_id..."
    aws ec2 stop-instances \
        --profile "$AWS_PROFILE" \
        --instance-ids "$instance_id" \
        --output json > /dev/null
    
    print_info "Waiting for instance to stop..."
    aws ec2 wait instance-stopped \
        --profile "$AWS_PROFILE" \
        --instance-ids "$instance_id"
    
    print_info "Instance $instance_id is now stopped"
}

# Function to connect to instance via SSH
connect_instance() {
    local instance_id=$1
    local state=$(get_instance_state "$instance_id")
    
    # Check if instance is running
    if [ "$state" != "running" ]; then
        print_error "Instance $instance_id is not running (current state: $state)"
        print_info "Starting instance first..."
        start_instance "$instance_id"
    fi
    
    # Check if SSH key exists
    if [ ! -f "$SSH_KEY" ]; then
        print_error "SSH key not found at: $SSH_KEY"
        exit 1
    fi
    
    # Check SSH key permissions
    local key_perms=$(stat -c %a "$SSH_KEY" 2>/dev/null || stat -f %A "$SSH_KEY" 2>/dev/null)
    if [ "$key_perms" != "400" ] && [ "$key_perms" != "600" ]; then
        print_warning "SSH key has incorrect permissions. Fixing..."
        chmod 400 "$SSH_KEY"
    fi
    
    # Get public IP address
    print_info "Getting public IP address..."
    local public_ip=$(aws ec2 describe-instances \
        --profile "$AWS_PROFILE" \
        --instance-ids "$instance_id" \
        --query "Reservations[0].Instances[0].PublicIpAddress" \
        --output text 2>/dev/null)
    
    if [ "$public_ip" == "None" ] || [ -z "$public_ip" ]; then
        print_error "No public IP address found for instance $instance_id"
        exit 1
    fi
    
    # Get username from instance tags or use default
    local username=$(aws ec2 describe-instances \
        --profile "$AWS_PROFILE" \
        --instance-ids "$instance_id" \
        --query "Reservations[0].Instances[0].Tags[?Key=='Username'].Value | [0]" \
        --output text 2>/dev/null)
    
    # If no username tag, try to determine from AMI or use default
    if [ "$username" == "None" ] || [ -z "$username" ]; then
        local ami_name=$(aws ec2 describe-instances \
            --profile "$AWS_PROFILE" \
            --instance-ids "$instance_id" \
            --query "Reservations[0].Instances[0].ImageId" \
            --output text 2>/dev/null)
        
        # Default to ubuntu, but you can add logic to detect AMI type
        username="ubuntu"
        print_info "No Username tag found, using default: $username"
    fi
    
    print_info "Connecting to $public_ip as $username..."
    print_info "Connecting with sshuttle (localhost forwarding enabled)"

    # Start sshuttle for localhost forwarding
    print_info "Starting sshuttle tunnel"
    sshuttle -D -r "$username@$public_ip" 127.0.0.1/32 -e "ssh -i $SSH_KEY"

    print_info "Connecting via SSH"
    ssh -i "$SSH_KEY" "$username@$public_ip"

    pkill -f "sshuttle.*$public_ip"
}

# Main script logic
main() {
    # Check if action is provided
    if [ $# -eq 0 ]; then
        print_error "Usage: workspace {start|stop|connect}"
        exit 1
    fi
    
    local action=$1
    
    # Validate action
    if [ "$action" != "start" ] && [ "$action" != "stop" ] && [ "$action" != "connect" ]; then
        print_error "Invalid action: $action"
        print_error "Usage: workspace {start|stop|connect}"
        exit 1
    fi
    
    # Check if AWS CLI is installed
    if ! command -v aws &> /dev/null; then
        print_error "AWS CLI is not installed. Please install it first."
        exit 1
    fi
    
    # Get instance ID
    print_info "Looking for EC2 instance with tag ${TAG_KEY}=${TAG_VALUE}..."
    instance_id=$(get_instance_id)
    
    if [ $? -ne 0 ]; then
        print_error "No instance found with tag ${TAG_KEY}=${TAG_VALUE}"
        exit 1
    fi
    
    print_info "Found instance: $instance_id"
    
    # Perform action
    case "$action" in
        start)
            start_instance "$instance_id"
            ;;
        stop)
            stop_instance "$instance_id"
            ;;
        connect)
            connect_instance "$instance_id"
            ;;
    esac
}

# Run main function
main "$@"
